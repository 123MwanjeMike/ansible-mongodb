---

# https://www.digitalocean.com/community/tutorials/how-to-implement-replication-sets-in-mongodb-on-an-ubuntu-vps
# https://www.digitalocean.com/community/tutorials/how-to-create-a-sharded-cluster-in-mongodb-using-an-ubuntu-12-04-vps
# https://docs.mongodb.com/manual/tutorial/deploy-shard-cluster/


  - name: Stop the daemon service
    become: true
    service: name=mongod state=stopped

  - name: Stop the shard service, if applicable
    become: true
    service: name=mongos state=stopped
    when: mongodb_type == "shard"

  - name: Enable mongod service, if applicable
    become: true
    service: name=mongod enabled=yes
    when: mongodb_type == "daemon"

  - name: Disable mongod service, if applicable
    become: true
    service: name=mongod enabled=no
    when: mongodb_type == "shard"

  - name: Enable mongos service, if applicable
    become: true
    service: name=mongos enabled=yes
    when: mongodb_type == "shard"

  - name: Copying daemon system file templates
    become: true
    template: src={{ item. src }} dest={{ item.dest }} owner=root group=root mode="u=rw,g=r,o=r"
    with_items:
      - { src: ../templates/mongod.service.j2, dest: /lib/systemd/system/mongod.service }
      - { src: ../templates/mongod.conf.j2, dest: /etc/mongod.conf }

  - name: Copying shard templates, if needed
    become: true
    template: src={{ item. src }} dest={{ item.dest }} owner=root group=root mode="u=rw,g=r,o=r"
    with_items:
      - { src: ../templates/mongos.service.j2, dest: /lib/systemd/system/mongos.service }
      - { src: ../templates/mongos.conf.j2, dest: /etc/mongos.conf }
    when: mongodb_type == "shard"

#  - name: Ensure data directory exists
#    file: path=/srv/mongodb state=directory owner=mongodb group=mongodb mode=755
#    become: yes

  - name: Start the daemon service, if needed
    become: true
    service: name=mongod state=started
    when: mongodb_type == "daemon"

  - name: Start the shard service, if needed
    become: true
    service: name=mongos state=started
    when: mongodb_type == "shard"
