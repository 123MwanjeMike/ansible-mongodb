---

  - name: Stop services
    include: service-stop.yml

  - name: Enable mongod service, if applicable
    become: true
    service: name=mongod enabled=yes
    when: mongodb_type == "daemon"

  - name: Disable mongod service, if applicable
    become: true
    service: name=mongod enabled=no
    when: mongodb_type == "shard"

  - name: Enable mongos service, if applicable
    become: true
    service: name=mongos enabled=yes
    when: mongodb_type == "shard"

  - name: Copying daemon system file templates
    become: true
    template: src={{ item. src }} dest={{ item.dest }} owner=root group=root mode="u=rw,g=r,o=r"
    with_items:
      - { src: ../templates/mongod.service.j2, dest: /lib/systemd/system/mongod.service }
      - { src: ../templates/mongod.conf.j2, dest: /etc/mongod.conf }

  - name: Copying shard templates, if needed
    become: true
    template: src={{ item. src }} dest={{ item.dest }} owner=root group=root mode="u=rw,g=r,o=r"
    with_items:
      - { src: ../templates/mongos.service.j2, dest: /lib/systemd/system/mongos.service }
      - { src: ../templates/mongos.conf.j2, dest: /etc/mongos.conf }
    when: mongodb_type == "shard"

  - name: Truncate logs
    become: true
    file: path={{ item.path }} state=absent  # state=empty
    when: >
      ( files is defined and not files.skipped|bool == true )
    with_items:
      - /var/log/mongodb/mongod.log
      - /var/log/mongodb/mongos.log

  - name: Reset directories
    include: directories-init.yml
    no_log: true

  - name: Start the appropriate services
    include: service-start.yml

